# stabilizing_drone_movies_by_ffmpeg



## 開発動機

子どもと一緒に遊べるトイドローンや100g未満の軽量ドローンで撮った映像が、ガタガタで観にくくなってしまって活用できていないことに気づき、何とかしたいなと思っていました。Google Colabのサイトに、Geminiが伴奏してくれるようになったので、Geminiとの対話でコーディングできましたので、シェアします。



[vidstab](https://adamspannbauer.github.io/python_video_stab/html/index.html)

[vidstab on GitHub](https://github.com/AdamSpannbauer/python_video_stab)


ソフトウェアジンバルとも言われる機能ですね。

---

## 実行サンプル

* 入力動画を左に、処理後の出力動画を右に対比して再生しています。

[比較動画の再生](https://github.com/consultant-decole/movie_stabilization_by_ffmpeg/issues/1#issue-3885884238)

---

## 主な機能

1.  **フレームレートの自動検出**
    * `ffprobe` を使用して入力動画の正確な平均フレームレート（FPS）を取得し、出力動画に整合性を持たせます。
2.  **2パス・スタビライズ処理**
    * **Step 1 (検出):** `vidstabdetect` で動画の動きを解析し、一時的な解析ファイル（`.trf`）を生成。
    * **Step 2 (補正):** 解析データを元に、映像を逆方向にシフトさせて揺れを打ち消します。
3.  **キャンバスの拡張（パディング）**
    * 元の動画サイズの **1.4倍** のキャンバスを作成し、中央に配置します。
    * 補正によって映像が上下左右に動いても、背景の黒い領域（ブラックボーダー）がそれを受け止めるため、映像の欠損を防ぎます。
4.  **重複処理のスキップ**
    * 既に出力ファイルが存在する場合は処理をスキップし、効率的にバッチ処理を行います。

---

## 技術スタック

* **Python 3**
* **FFmpeg** ( `vid.stab` モジュールが有効なもの)
* **ffprobe** (動画解析用)

---

## 処理フロー

| ステップ | 処理内容 | 詳細 / パラメータ |
| :--- | :--- | :--- |
| **0. 解析** | FPS取得 | `ffprobe -v error -select_streams v:0` |
| **1. 検出** | 揺れの解析 | `vidstabdetect=shakiness=5:accuracy=15` |
| **2. 生成** | 補正 & 拡張 | `vidstabtransform=optzoom=0` / `pad=iw*1.4:ih*1.4` |
| **3. 保存** | 高画質出力 | `libx264`, `crf 18`, `preset slow` |

---

## フィルター設定の詳細

スクリプト内で指定されている主要なオプションの解説です。

* **`smoothing=20`**: 補正の滑らかさ。数値が高いほど滑らかになりますが、映像の動きが大きくなります。
* **`optzoom=0`**: ズームを無効化。これが `0` であるため、映像の端に黒い余白が現れます。
* **`interpol=bicubic`**: 補間アルゴリズム。高品質な双三次補間を使用してピクセルを再配置します。
* **`pad=iw*1.4:ih*1.4:(ow-iw)/2:(oh-ih)/2:black`**:
    * 出力サイズを元の 140% に設定し、映像を中央（Center）に配置します。

---

## 注意事項

* **一時ファイル**: 解析用の `transform.trf` は、処理完了後に自動的に削除されます。
* **依存関係**: FFmpegがインストールされ、パスが通っている必要があります。

---

## 環境準備

* **作業フォルダの設定:** .envファイルを.env.blankを元に作成ください(下段の実行環境の項目を参照)。

---

## 実行環境

* **ディレクトリ設定**: .env.sampleを元にして、下記の変数をご自身の入力動画格納先と、出力動画の保存先として入力して、.envとファイル名を変更して、プログラムが参照できるように読み込ませてください。

* **入力ディレクトリ**: SEARCH_DIR = "ここに入力動画保存先パス"

* **出力ディレクトリ**: OUTPUT_DIR = "ここに出力動画の保存先"

